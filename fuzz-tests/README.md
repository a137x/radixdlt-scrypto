# Introduction

This package implements fuzz tests for Radix Engine.
Currently it uses 3 fuzzing engines:
* [LibFuzzer](https://llvm.org/docs/LibFuzzer.html)
  It is wrapped by crate: [cargo-fuzz](https://docs.rs/crate/cargo-fuzz/0.11.2)
* [AFLplusplus](https://aflplus.plus/)
  It is wrapped by crate: [cargo-afl](https://docs.rs/afl/0.12.14/afl)
* simple-fuzzer
  This is a very simple fuzzer, which is especially useful when developing new fuzz tests.
  It allows to:
  - quickly rebuild a test and perform some simple checks (building libfuzzer or AFL takes ages).
  - reproduce a crash (or other problematic case) using provided input file,
    (which might be generated by libfuzzer or AFL)

# LibFuzzer
* At the moment it is possible to use it only with rust `nightly` builds.
* Must be built with `no-cfg-fuzzing` option, to skip setting `fuzzing` flag.
  Crate `secp256k1` uses some stubs instead of true cryptography if `fuzzing` is set
  (for details see: https://github.com/rust-bitcoin/rust-secp256k1/#fuzzing), which makes it unusable
  for our purposes.
* It does not require fuzz input data, but it is preferred to provide it to increase fuzzing efficiency.

## Installation
```
cargo +nightly install cargo-fuzz
```

# AFL
* Similarly to `libfuzzer` it sets `fuzzing` flag by default.
  Thus `cargo afl` shall be built and installed using below command
  ```
  cargo install afl --features no_cfg_fuzzing
  ```
* It requires some input data to be provided.

## Installation
One can use convenience script [install_afl.sh](./install_afl.sh) to install `cargo-afl` with the change mentioned above.

## Machine setup
Before starting to fuzz AFL checks machine configuration and requests to adjust some settings if required.
* Linux
  - do not send core dump notifications to external utilities.
    This is to notify fuzzer immediately about the crash, so it does not misinterpret crash as timeout.
    `sudo bash -c "echo core > /proc/sys/kernel/core_pattern"`

    Alternatively it is possible to use env `AFL_I_DONT_CARE_ABOUT_MISSING_CRASHES=1`
  - disable CPU frequency scaling to provide best performance
    `sudo bash -c "cd /sys/devices/system/cpu ; echo performance | tee cpu*/cpufreq/scaling_governor >/dev/null"`

    Alternatively it is possible to use env `AFL_SKIP_CPUFREQ=1`

* MacOS
  If you see an error message like `shmget() failed` above, try running the following command:
  ```
  sudo /Users/<username>/.local/share/afl.rs/rustc-1.67.1-d5a82bb/afl.rs-0.12.14/afl/bin/afl-system-config
  ```

# Input data
Sample input data shall be placed in `fuzz_input` folder in dedicated subfolder.
`libfuzzer` and `AFL` are able to use the data in the same format.

In order to minimize the test corpus, the data might be prior processed.
Processing method is specific for fuzzing engine.

One can use following command to generate input data (`cargo afl cmin|tmin` are used here)
`./fuzz.sh generate-input [raw|unique|minimize]`
Check `./fuzz.sh help` for more details

# Fuzz tests
Available fuzz tests:
* transaction - Fuzzes transaction manifests and tries to execute it

# Usage

Helper script [fuzz.sh](./fuzz.sh) to unify fuzzing experience accross the fuzzing engines ;)

`./fuzz.sh [FUZZER/COMMAND] [SUBCOMMAND] [COMMAND-ARGS]`

Currently it allows to build and run fuzz tests using some default configuration.
Check: `./fuzz.sh help` for more details.

For more sophisticated use cases `cargo fuzz` or `cargo afl` shall be used directly.
Check:
`cargo +nightly fuzz --help`
or
`cargo afl --help`

## Examples
* Generate input
  - Generate input
    ```
    ./fuzz.sh generate-input raw|unique|minimize
    ```
  - Generate unique input
* AFL
  - Run 2 AFL sessions (`main` and `slave`) and let it automatically resume if the same session was already running
    (each command in separate console)
    ```
    AFL_AUTORESUME=1 cargo afl fuzz -i fuzz_input/transaction -o afl/transaction -M main -T transaction  target-afl/release/transaction
    ```
    ```
    AFL_AUTORESUME=1 cargo afl fuzz -i fuzz_input/transaction -o afl/transaction -S slave -T transaction  target-afl/release/transaction
    ```
  - Check status of the AFL fuzzing session in the AFL output folder `afl/transaction`
    ```
    cargo afl whatsup afl/transaction
    ```
* LibFuzzer
  - Run 2 LibFuzzer sessions and do not stop if crash discovered
    ```
    cargo +nightly fuzz run --release --no-default-features --features std,libfuzzer-sys --fuzz-dir . --no-cfg-fuzzing --target-dir target-libfuzzer transaction -- -create_missing_dirs=1 -jobs=2 -fork=1 -ignore_crashes=1
    ```
    If fuzzer is running in forked mode it logs to file (file per job) `file-<job_number>.log`.
    One can monitor logs using below command:
    ```
    tail -f file-*.log
    ```
  - Reproduce discovered crash
    ```
    cargo +nightly fuzz run --release --no-default-features --features std,libfuzzer-sys --fuzz-dir . --no-cfg-fuzzing --target-dir target-libfuzzer transaction artifacts/transaction/crash-0734fdddb6de62d6d954c06c65b310d185656e10
    ```
* simple-fuzzer
  - Reproduce discovered crash
    ```
    ./fuzz.sh simple run artifacts/transaction/crash-0734fdddb6de62d6d954c06c65b310d185656e10
    ```
    or
    ```
    RUST_BACKTRACE=1 cargo run --release --no-default-features --features std,simple-fuzzer --bin transaction -- -v artifacts/transaction/crash-0734fdddb6de62d6d954c06c65b310d185656e10
    ```

# Future considerations
- Implement more smart mutations in 'transaction' fuzz test
- Add more fuzz tests
- any ideas?
